generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model UserProfile {
  id         Int    @id @default(autoincrement())
  userId     String @db.Uuid
  name       String?
  phone      String?
  language   Language? @relation(fields: [languageId], references: [id])
  languageId Int?
  onboardingCompleted Boolean  @default(false)
  neoCommunities UserNeoCommunity[]
  votes        Vote[]
  requests     TranslationRequest[] @relation("RequestedBy")
  approvals    TranslationRequest[] @relation("ApprovedBy")

  @@unique([userId])
  @@map("user_profile")
}

model Role {
  id    Int        @id @default(autoincrement())
  name  String     @unique
  users UserRole[]

  @@map("roles")
}

model UserRole {
  id     Int    @id @default(autoincrement())
  userId String @db.Uuid
  roleId Int

  role Role @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Language {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  is_supported Boolean  @default(false)
  icon         String?
  userProfiles UserProfile[]
  terms        Term[]
  requests     TranslationRequest[]

  @@map("language")
}

model PartOfSpeech {
  id       Int                  @id @default(autoincrement())
  name     String               @unique // e.g. Noun
  code     String               @unique // e.g. N
  terms    Term[]
  requests TranslationRequest[]

  @@map("part_of_speech")
}

model Concept {
  id          Int          @id @default(autoincrement())
  gloss       String?      // Universal explanation of the concept
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  terms       Term[]
  definitions Definition[]

  @@map("concepts")
}

model Term {
  id             Int          @id @default(autoincrement())
  text           String

  languageId     Int
  language       Language     @relation(fields: [languageId], references: [id])

  partOfSpeechId Int
  partOfSpeech   PartOfSpeech @relation(fields: [partOfSpeechId], references: [id])

  conceptId      Int
  concept        Concept      @relation(fields: [conceptId], references: [id])
  
  votes          Vote[]
  voteScore      Int          @default(0) // Cached score for sorting

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("terms")
}

model Definition {
  id        Int      @id @default(autoincrement())
  text      String

  conceptId Int
  concept   Concept  @relation(fields: [conceptId], references: [id])

  @@map("definitions")
}

model Vote {
  id        Int         @id @default(autoincrement())
  value     Int         // 1 for upvote, -1 for downvote
  
  userId    String      @db.Uuid
  user      UserProfile @relation(fields: [userId], references: [userId])
  
  termId    Int
  term      Term        @relation(fields: [termId], references: [id])
  
  createdAt DateTime    @default(now())

  @@unique([userId, termId])
  @@map("votes")
}

model Domain {
  id       Int                 @id @default(autoincrement())
  name     String              @unique
  requests DomainsOnRequests[]

  @@map("domains")
}

model TranslationRequest {
  id             Int          @id @default(autoincrement())
  word           String
  meaning        String?      // Context provided by user

  languageId     Int
  language       Language     @relation(fields: [languageId], references: [id])
  
  partOfSpeechId Int
  partOfSpeech   PartOfSpeech @relation(fields: [partOfSpeechId], references: [id])

  userId         String       @db.Uuid
  user           UserProfile  @relation("RequestedBy", fields: [userId], references: [userId])

  domains        DomainsOnRequests[]

  // Approval System
  isApproved     Boolean      @default(false)
  approvedById   String?      @db.Uuid
  approvedBy     UserProfile? @relation("ApprovedBy", fields: [approvedById], references: [userId])

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@map("translation_requests")
}

model DomainsOnRequests {
  requestId Int
  request   TranslationRequest @relation(fields: [requestId], references: [id])
  
  domainId  Int
  domain    Domain             @relation(fields: [domainId], references: [id])
  
  @@id([requestId, domainId])
  @@map("domains_on_requests")
}

model NeoCommunities {
  id             Int           @id @default(autoincrement())
  name           String
  users          UserNeoCommunity[]

  @@unique([name])
  @@map("neo_communities")
}

model UserNeoCommunity {
  id             Int    @id @default(autoincrement())
  userId         String @db.Uuid
  neoCommunityId Int

  userProfile  UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  neoCommunity NeoCommunities @relation(fields: [neoCommunityId], references: [id], onDelete: Cascade)

  @@unique([userId, neoCommunityId])
  @@map("user_neo_communities")
}
